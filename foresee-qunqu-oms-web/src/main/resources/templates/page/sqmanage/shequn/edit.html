<!DOCTYPE html>
<html class="iframe-h">
	<head>
		<meta charset="UTF-8">
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>编辑社群</title>
		<link rel="stylesheet" type="text/css" href="/static/layui/css/layui.css" />
		<link rel="stylesheet" type="text/css" href="/css/admin.css" />
		<link rel="stylesheet" type="text/css" href="/css/formSelects-v4.css" />
		<link rel="stylesheet" type="text/css" href="/css/page.css" />
		<style>
			.layui-form-label{width:100px;}
			.layui-input,.xm-select-parent .xm-input{width:200px;}
			.mar-r-s{margin-right:125px;}
			.layer-textarea{width:420px;}
		</style>
	</head>
	<body>
		<div class="pageloading">
			<img src="/images/loading.png" class="rotation" />
		</div>
		<div class="wrap-container clearfix">
			<div class="column-content-detail">
				<form class="layui-form">
					<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityName">社群名称：</label>
					        <div class="layui-input-inline">
					        	<input type="text" id="communityName" name="community_name" lay-verify="community_name" value="" autocomplete="off" class="layui-input" placeholder="请输入社群名称" />
					        </div>
					    </div>
					    <div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityMark">社群签名：</label>
					        <div class="layui-input-inline">
					        	<input type="text" id="communityMark" name="community_mark" lay-verify="community_mark" value="" autocomplete="off" class="layui-input" placeholder="请输入社群签名" />
					        </div>
					    </div>
				  	</div>
				  	<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityTag">社群标签：</label>
					        <div class="layui-input-inline">
					        	<select id="communityTag" name="community_tag" xm-select="xm-communityTag">
									<option value="">请选择社群标签</option>
								</select>
					        </div>
					    </div>
					    <div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="authDesc">认证信息：</label>
					        <div class="layui-input-inline">
					        	<input type="text" id="authDesc" name="auth_desc" lay-verify="auth_desc" value="" autocomplete="off" class="layui-input" placeholder="请输入社群认证信息说明" />
					        </div>
					    </div>
				  	</div>
				  	<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityType">社群类别：</label>
					        <div class="layui-input-inline">
					        	<select id="communityType" name="community_type">
									<option value="">请选择社群类别</option>
								</select>
					        </div>
					    </div>
					    <div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communitySts">社群状态：</label>
					        <div class="layui-input-inline">
					        	<select id="communitySts" name="community_sts">
									<option value="">请选择社群状态</option>
									<option value="1">正常</option>
									<option value="0">非正常</option>
								</select>
					        </div>
					    </div>
				  	</div>
				  	<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="adminId">所属社长：</label>
					        <div class="layui-input-inline">
					        	<input type="text" id="adminId" rel="" name="admin_id" lay-verify="admin_id" value="" autocomplete="off" class="layui-input" placeholder="请选择所属社长" readOnly='readOnly' />
					        </div>
					        <button type="button" class="layui-btn layui-btn-sm layui-btn-normal mar-left" id="checkSz">更换社长</button>
					    </div>
				  	</div>
				  	<div class="pad-top">
					    <div class="layui-inline mar-r-s" style="width:270px;">
					        <label class="layui-form-label" for="logoUpOne">社群图标：</label>
					        <div class="layui-input-inline" style="position:relative;">
					       		<input type="file" id="logoUpOne" class="logo-up op-0" accept="image/gif,image/jpeg,image/jpg,image/png,image/svg"/>
					        	<img id="communityIcon" src="/images/up_logo.png" class="up-img" />
					        </div>
					    </div>
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="logoUpTwo">社群背景：</label>
					        <div class="layui-input-inline" style="position:relative;">
					       		<input type="file" id="logoUpTwo" class="logo-up op-0" accept="image/gif,image/jpeg,image/jpg,image/png,image/svg"/>
					        	<img id="bgIcon" src="/images/up_logo.png" class="up-img" />
					        </div>
					    </div>
				  	</div>
				  	<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityNotice">社群公告：</label>
					        <div class="layui-input-inline">
						    	<textarea placeholder="请输入社群公告" id="communityNotice" class="layui-textarea layer-textarea"></textarea>
						    </div>
					    </div>
				  	</div>
				  	<div class="pad-top">
				  		<div class="layui-inline mar-r-s">
					        <label class="layui-form-label" for="communityDesc">社群说明：</label>
					        <div class="layui-input-inline">
						    	<textarea placeholder="请输入社群说明" id="communityDesc" class="layui-textarea layer-textarea"></textarea>
						    </div>
					    </div>
				  	</div>
				  	<div class="pad-top-b">
				  		<div class="layui-inline">
						    <button class="layui-btn layui-btn-sm layui-btn-normal mar-left" onClick="return false;" id="yesSubmit">确&nbsp;&nbsp;认</button>
						    <button class="layui-btn layui-btn-sm layui-btn-normal mar-left" onClick="return false;" id="noSubmit">取&nbsp;&nbsp;消</button>
					    </div>
				  	</div>
      			</form>
			</div>
		</div>
	</body>
	<script src="/static/layui/layui.js" type="text/javascript" charset="utf-8"></script>
	<script src="/js/jquery-1.8.0.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="/js/public.js" type="text/javascript" charset="utf-8"></script>
	<script src="/js/formSelects-v4.js"></script>
	<script type="text/javascript" charset="utf-8">
	layui.use(['form', 'laydate', 'laypage', 'layer'], function(){
		var form = layui.form, laydate = layui.laydate, laypage = layui.laypage, layer = layui.layer,formSelects = layui.formSelects;  //初始化layui控件
		var parame = public.getParame();
		formSelects.btns("xm-communityTag", []);
		var img_one = '';  //社群图标
		var img_two = '';  //社群背景
		//请求标签
	    $.ajax({
	    	type: 'post',
	    	url: '/tag/selectlist',
	    	data: {'page': 1, 'limit': 999999999, 'tagType': 0},
	    	async: false,
			dataType: 'json',
			success: function(data) {
				if(data.code == '0'){
					var sign_str = "";
			       	var sign_arr = [];
		        	//标签管理列表数据
		        	$.each(data.data,function(k,val){
		        		sign_str = {"name": val.tagName, "value": val.id};
		        		sign_arr.push(sign_str);
			        });
					formSelects.data('xm-communityTag', 'local', {arr: sign_arr});
				}else{
					layer.alert(data.msg, {icon: 5, title: "提示"});
				}
			}
	    });
	    //请求社长
	    $("#checkSz").click(function() {
	    	public.dialogLayer(2,"选择社长","/view/communitys/shequnwechat.html?ids=" + $("#adminId").attr("rel"),"1000px","500px");
	    });
	    //请求类别
	    $.ajax({
	    	type: 'post',
	    	url: '/communityfamily/selectlist',
	    	data: {'page': 1, 'limit': 999999999},
	    	async: false,
			dataType: 'json',
			success: function(data) {
				if(data.code == '0'){
					var str = '';
					//回显社群类别
					$.each(data.data, function (k, val) {
						str += '<option value="' + val.id + '">' + val.familyName + '</option>';
					});
					$("#communityType").html("");
					$("#communityType").append("<option value=''>请选择社群类别</option>"+ str);
					form.render();
				}else{
					layer.alert(data.msg, {icon: 5, title: "提示"});
				}
			}
	    });
	    //信息回显
	    $.ajax({
	    	type: 'post',
	    	url: '/communitys/select',
	    	data: {'id': parame.id},
	    	async: false,
			dataType: 'json',
			success: function(data) {
				if(data.code == '0'){
					//回显多选项
					if(data.data.communityTag == '1'){
						var status = [data.data.communityTag];
					}else{
						var status = data.data.communityTag.split(',');
					}
					$("#communityName").val(data.data.communityName);  //社群名称
			    	$("#communityMark").val(data.data.communityMark);  //社群签名
			    	layui.formSelects.value("xm-communityTag", status);  //社群标签
			    	$("#authDesc").val(data.data.authDesc);  //认证信息
			    	//社群类别
			    	$("#communityType option").each(function(index){
		            	if($(this).attr("value") == data.data.communityType){
		            		$(this).attr("selected",true);
		            	}
		            });
			    	//社群状态
			    	$("#communitySts option").each(function(index){
		            	if($(this).attr("value") == data.data.communitySts){
		            		$(this).attr("selected",true);
		            	}
		            });
			    	$("#communityNotice").val(data.data.communityNotice);  //社群公告
			    	$("#communityDesc").val(data.data.communityDesc);  //社群说明
			    	img_one = data.data.communityIcon;
			    	$("#communityIcon").attr("src", data.data.communityIcon);  //社群图标
			    	img_two = data.data.bgIcon;
			    	$("#bgIcon").attr("src", data.data.bgIcon);  //社群背景
			    	var admin_id = data.data.adminId;  //存储社长id
			    	/*if(admin_id == 0 || admin_id == "" || admin_id == null){
			    		admin_id = -1;
			    	}*/
			    	$.ajax({
				    	type: 'post',
				    	url: '/wechatuser/select',
				    	data: {'id': admin_id},
				    	async: false,
						dataType: 'json',
						success: function(data) {
							if(data.code == '0'){
						    	//所属社长
						    	if(data.data != undefined && data.data != null){
						    		$("#adminId").attr("rel", data.data.id);
				    				$("#adminId").val(data.data.nickName);
						    	}
							}
					    	form.render();
							$(".pageloading").hide();
						}
				    });
				}else{
					layer.alert(data.msg, {icon: 5, title: "提示"});
				}
			}
	    });
		//上传文件
        var logoUpOne = document.querySelector('#logoUpOne');
        var logoUpTwo = document.querySelector('#logoUpTwo');
	    $("#logoUpOne,#logoUpTwo").change(function(){
	    	var file = this.files[0];
            // 确认选择的文件是图片
            if(file.type.indexOf("image") == 0 && file.size <= 2048000) {
                var reader = new FileReader();
                var _that = $(this).attr("id");
                reader.readAsDataURL(file);
                reader.onload = function(e) {
                    var newUrl = this.result;
                    if(_that == "logoUpOne"){
                    	if(public.check_img(newUrl, 4)){
                    		$.post('/img/upload', {'base64img': newUrl.split(",")[1]}, function(data) {
                            	if(data.code == '0' && data.data != ""){
        		                    if(_that == "logoUpOne"){
        		                    	img_one = data.data;
        		                    	$("#communityIcon").attr("src", img_one);
        			                }else if(_that == "logoUpTwo"){
        			                	img_two = data.data;
        		                    	$("#bgIcon").attr("src", img_two);
        			                }  
                            	}else{
                            		layer.alert("上传出错", {icon: 5, title: "提示"});
                            	}
                            }, 'json');
          				}else{
          					layer.alert("图片比例有误！", {icon: 5, title: "提示"});
          				}
	                }else if(_that == "logoUpTwo"){
	                	if(public.check_img(newUrl, 5)){
	                		$.post('/img/upload', {'base64img': newUrl.split(",")[1]}, function(data) {
	                        	if(data.code == '0' && data.data != ""){
	    		                    if(_that == "logoUpOne"){
	    		                    	img_one = data.data;
	    		                    	$("#communityIcon").attr("src", img_one);
	    			                }else if(_that == "logoUpTwo"){
	    			                	img_two = data.data;
	    		                    	$("#bgIcon").attr("src", img_two);
	    			                }  
	                        	}else{
	                        		layer.alert("上传出错", {icon: 5, title: "提示"});
	                        	}
	                        }, 'json');
	      				}else{
	      					layer.alert("图片比例有误！", {icon: 5, title: "提示"});
	      				}
	                }
                };
            }else{
            	layer.alert("上传文件必须是图片且小于2M", {icon: 5, title: "提示"});
            }
	    });
	    //点击确定
	    $("#yesSubmit").click(function() {
	    	//获取数据传递
	    	var community_name = $.trim($("#communityName").val());  //社群名称
	    	var community_mark = $.trim($("#communityMark").val());  //社群签名
	    	var community_tag = layui.formSelects.value('xm-communityTag', 'valStr');  //社群标签
	    	var auth_desc = $.trim($("#authDesc").val());  //认证信息
	    	var community_type = $.trim($("#communityType").val());  //社群类别[非必填]
	    	var community_sts = $.trim($("#communitySts").val());  //社群状态
	    	var community_notice = $.trim($("#communityNotice").val());  //社群公告
	    	var community_desc = $.trim($("#communityDesc").val());  //社群说明
	    	var admin_id = $.trim($("#adminId").attr("rel"));  //所属社长
	    	if(community_name && community_mark && community_tag && community_sts && community_desc && img_one && img_two && admin_id != ""){
		    	$.post('/communitys/update', {
		    		'id': parame.id,
		    		'communityName': community_name,
		    		'communityMark': community_mark,
		    		'communityTag': community_tag,
		    		'authDesc': auth_desc,
		    		'communityType': community_type,
		    		'communitySts': community_sts,
		    		'communityNotice': community_notice,
		    		'communityDesc': community_desc,
		    		'communityIcon': img_one,
		    		'bgIcon': img_two,
		    		'adminId': admin_id
		    	}, function(data) {
		    		if(data.code == '0'){
		    			layer.msg('编辑成功', {'icon': 1,time:500},function(){
						    var index = parent.layer.getFrameIndex(window.name);
				       	    parent.layer.close(index);
				       	    window.parent.location.reload();
	                    });
		    		}else{
		    			layer.alert(data.msg, {icon:5, title:"提示"});
		    		}
		    	}, 'json');
	    	}else{
	    		layer.alert("请先补全信息！", {icon:5, title:"提示"});
	    	}
	    });
	    //点击取消
	    $("#noSubmit").click(function() {
	    	var index = parent.layer.getFrameIndex(window.name);
       		parent.layer.close(index);
	    });
	});
	</script>
</html>